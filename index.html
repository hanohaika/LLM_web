<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatGPT チャット</title>
  <style>
    body {margin: 20px; background: #f1f1f1;}
    .container {max-width: 670px; margin: auto; padding: 15px; background: #fff; border-radius: 15px;}
    .panel {padding: 0px 15px 15px 15px; margin: 5px 0px; border: 1px solid #ccc; border-radius: 8px;}
    .gpt-panel {background-color: #d6eaf8;}
    .session-panel {background-color: #fef6e4;}
    .reset-panel {background-color: #eeeeee;}

    .form-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; flex-wrap: wrap;}
    .form-row label { font-weight: bold; white-space: nowrap; font-size: 0.8em}
    select, input{ flex-grow: 1; padding: 3px; box-sizing: border-box; min-width: 50px; }
    #role { flex-grow: 2; min-width: 200px; }
    #temperature, #max-tokens { max-width: 65px; }

    .ask-row { display: flex; gap: 10px; margin-top: 0px; flex-wrap: nowrap;}
    .checkbox-inline {display: flex;padding: 10px 10px;  user-select: none; cursor: pointer; background-color: #007bff; color: white; border-radius: 6px;align-items: center;height:20px;max-width:150px;}
    .checkbox-inline input{ transform: scale(1.3); cursor: pointer; margin: 0;height:20px;}
    .ask-button { padding: 10px ; background-color: #007bff; color: white; font-weight: bold; border: none; border-radius: 6px; cursor: pointer;width: 100%;}
    .ask-button:hover { background-color: #0056b3; }

    .chat-log { max-height: 800px; overflow-y: auto; display: flex; flex-direction: column; margin-bottom: 10px;}
    .bubble { padding: 6px 15px; border-radius: 15px; margin: 3px 0; max-width: 85%; white-space: pre-wrap; overflow-wrap: break-word;font-size: 0.8em;}
    .user {  background: #f9e6e6;   align-self: flex-end;}
    .assistant {  background: #f0f4c3; align-self: flex-start;}    
    textarea { width: 100%; padding: 5px; margin: 8px 0; box-sizing: border-box; resize: vertical;  max-height: 300px;  overflow-y: auto;}

    button {width: 100%; padding: 10px; margin-bottom: 5px;  flex-grow: 1;}
    button:hover { background-color: #bbbbbb; }

    .info-inline { font-size: 0.8em; color: #555; display: flex; flex-wrap: wrap;  gap: 5px;}
    .buttons-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .buttons-row button { flex-grow: 1; width: auto; padding: 8px; font-weight: normal; }
    #past-sessions { margin-top: 10px; display: flex; flex-direction: column; gap: 2px;}
    #past-sessions > div { display: flex; align-items: center; gap: 0px;}
    #past-sessions button { padding: 5px 1px; font-size: 12px; min-width: 0px; flex-grow: 0;}
    .button-inline { display: inline-block; margin-right: 8px;}
    .three-buttons button {flex: 1;min-width: 0;}
    .small-input { max-width: 150px; padding: 2px 2px; font-size: 0.85em; }
    .small{font-size: 0.8em;white-space: nowrap}
    .footer {  text-align: center;  font-size: 0.75em;  color: #888;  margin-top: 20px;}
    #modal { position: fixed;  top: 10%;  left: 5%;  right: 5%;  bottom: 10%;  background: #fff;  border: 1px solid #ccc;  padding: 0; overflow: hidden;  z-index: 9999;  box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);  border-radius: 8px;  display: none;  flex-direction: column;  max-width:700px;margin: auto;}
    #modal-header {  display: flex;  justify-content: flex-end;  padding: 8px 12px;  background-color: #f5f5f5;  border-bottom: 1px solid #ccc;}
    #modal-close { background: transparent;  border: none;  font-size: 14px;  cursor: pointer;  color: #333;  padding: 2px 2px;   line-height: 1;}
    #modal-content {  flex: 1;  padding: 10px;  overflow-y: auto;  white-space: pre-wrap;max-height: 90%;}

@media screen and (max-width: 600px) {
  .form-row {flex-wrap: nowrap;gap: 5px;}
  .form-row label,.form-row select,.form-row input {font-size: 11px;min-width: 10px; }
  #role {font-size: 11px;}
  .bubble {font-size: 12px;padding: 6px 10px; border-radius: 8px; margin: 3px 0; max-width: 80%;}
  body {margin: 5px;}
  .container { padding: 5px;border-radius: 7px;}
  .panel {padding: 0px 8px 5px 8px; border-radius: 5px;}
  .ask-button, .buttons-row button,button {font-size: 12px;}
  .checkbox-inline { font-size: 11px; padding: 2px;}
  .checkbox-inline input{ transform: scale(1.1);}
  h3 {font-size: 16px;margin-top: 7px;margin-bottom: 5px;}
  .buttons-row {gap: 5px; flex-wrap: wrap; }
  #past-sessions {font-size: 12px;}
　button {width: 100%; padding: 1px; margin-bottom: 3px;  flex-grow: 1;}
  .ask-row {gap: 5px;}
  .ask-row label { font-size: 12px; padding: 9px 4px;  display: flex;}
  .ask-button { padding: 10px 2px;}
  .footer {  text-align: center;  font-size: 0.6em;  color: #888;  margin-top: 10px;}
  .info-inline { font-size: 0.7em; gap: 3px;}
}
  </style>
</head>

<body>
<div class="container">
<h3>💬 ChatGPT　チャットアプリ 💬</h3>
 <div class="form-row">
   <label for="api-key">APIキー：</label><input type="password" id="api-key" value="" />
 </div>
 <div class="form-row">
   <label for="model">モデル：</label><select id="model" class="small-input"><option value="gpt-4o-mini">GPT‑4o‑mini</option><option value="gpt-4.1-mini" selected>GPT‑4.1‑mini</option><option value="gpt-4.1-nano">GPT‑4.1‑nano</option><option value="o3-mini">o3‑mini</option></select>
      <label for="temperature">温度：</label><input type="number" id="temperature"  class="small-input" value="0.2" min="0.2" max="0.8" step="0.1" />
      <label for="max-tokens">最大トークン：</label><input type="number" id="max-tokens" value="8000" min="1000" max="20000" step="1000" class="small-input" />
    </div>
    <div class="form-row">
      <label for="role">役割：</label><input type="text" id="role" value="あなたは、とても有能なアシスタントです。" />
    </div>
<section class="panel gpt-panel">
    <div class="chat-log" id="chat-log"></div>
    <textarea id="question" rows="2" placeholder="質問を入力..."></textarea>
<div class="ask-row">
  <label class="checkbox-inline" for="continue-session"><span class="small">履歴引継</span><input type="checkbox" id="continue-session" /></label>
  <button id="ask-button" class="ask-button">❓GPTに聞く</button>
</div>
<div class="info-inline">
    　Input: <span id="session-in-tokens">0</span>｜Output: <span id="session-out-tokens">0</span>｜<span id="session-cost-jpy">¥0</span>

</div>
<div class="buttons-row three-buttons"><button id="clear-history">🗑️削除</button> <button id="end-session">📥アーカイブ</button></div>
</section>
<section class="panel session-panel">
    <div><h3>🔁 過去セッション 🔁</h3>
      <div id="past-sessions">
        <!-- チェックボックスとコピー用ボタンはここに動的に追加されます -->
      </div>
    </div>
    <div class="buttons-row three-buttons"><button id="delete-selected">🗑️☑を削除</button><button id="export-selected">📄☑をtxt保存</button></div>
    <div class="info-inline">【累計】 Input: <span id="total-in-tokens">0</span>｜Output: <span id="total-out-tokens">0</span>｜<span id="cost-jpy">¥0</span></div>
</section>


<section class="panel reset-panel">
    <div><h3>🗑️ データ削除 🗑️</h3>
	<div class="buttons-row three-buttons"><button id="clear-cost">料金</button> <button id="clear-all-sessions">過去セッション</button></div></div>
</section>

<div id="modal">
  <div id="modal-header">
    <button id="modal-close">✖閉じる✖</button>
  </div>
  <pre id="modal-content"></pre>
</div>


<footer class="footer">
    © 2025 ChatGPTチャットアプリ by AT. All rights reserved.
</footer>

<script>
const pricing = {'gpt-4o-mini': { inp: 0.15, out: 0.60 }, 'gpt-4.1-mini': { inp: 0.40, out: 1.60 }, 'gpt-4.1-nano': { inp: 0.10, out: 0.40 }, 'o3-mini': { inp: 2.00, out: 8.00 }};
const usdToJpy = 145;
let isRequesting = false;
let sessionMsgs = JSON.parse(localStorage.getItem('chat-history') || '[]');
let totalIn = parseInt(localStorage.getItem('in-tokens') || '0');
let totalOut = parseInt(localStorage.getItem('out-tokens') || '0');
let totalCost = parseFloat(localStorage.getItem('cost-jpy') || '0');
let sessionIn = 0;
let sessionOut = 0;
let sessionCost = 0;
const chatLog = document.getElementById('chat-log');
const inDisp = document.getElementById('total-in-tokens');
const outDisp = document.getElementById('total-out-tokens');
const costDisp = document.getElementById('cost-jpy');
const askBtn = document.getElementById('ask-button');

function append(role, txt) {
  if (role === 'system') return;
  const d = document.createElement('div'); d.className = 'bubble';
  d.classList.add(role === 'user' ? 'user' : 'assistant');
  d.textContent = txt; d.style.whiteSpace = 'pre-wrap';
  if (role === 'user') { const spacer = document.createElement('div'); spacer.style.marginBottom = '10px'; chatLog.appendChild(spacer); }
  chatLog.appendChild(d); chatLog.scrollTop = chatLog.scrollHeight;
}

function saveAll() {
  localStorage.setItem('chat-history', JSON.stringify(sessionMsgs));
  localStorage.setItem('in-tokens', totalIn);
  localStorage.setItem('out-tokens', totalOut);
  localStorage.setItem('cost-jpy', totalCost.toFixed(4));
  inDisp.textContent = totalIn;
  outDisp.textContent = totalOut;
  costDisp.textContent = '¥' + totalCost.toFixed(1);
document.getElementById('session-in-tokens').textContent = sessionIn;
  document.getElementById('session-out-tokens').textContent = sessionOut;
  document.getElementById('session-cost-jpy').textContent = '¥' + sessionCost.toFixed(3);
}

function formatTimestamp() {
  const now = new Date();
  return now.getFullYear() + '/' +
         String(now.getMonth() + 1).padStart(2, '0') + '/' +
         String(now.getDate()).padStart(2, '0') + ' ' +
         String(now.getHours()).padStart(2, '0') + ':' +
         String(now.getMinutes()).padStart(2, '0') + ':' +
         String(now.getSeconds()).padStart(2, '0');
}

function archiveSession() {
  const bubbles = chatLog.querySelectorAll('.bubble');
  if (bubbles.length === 0) return alert('チャットログが空です。');

  const newMsgs = [];
  bubbles.forEach(b => {
    const role = b.classList.contains('user') ? 'user' : 'assistant';
    const content = b.textContent;
    newMsgs.push({ role, content });
  });

 const timestamp = formatTimestamp();
  const archive = JSON.parse(localStorage.getItem('archived-sessions') || '[]');
  archive.push({ title: timestamp, messages: newMsgs });
  localStorage.setItem('archived-sessions', JSON.stringify(archive));

  sessionMsgs = [];
  localStorage.removeItem('chat-history');
  chatLog.innerHTML = '';
  renderPastSessions();
  saveAll();
  alert('セッションを終了し、過去セッションに保存しました。');
}

function renderPastSessions() {
  const container = document.getElementById('past-sessions'); container.innerHTML = '';
  const archive = JSON.parse(localStorage.getItem('archived-sessions') || '[]').slice().reverse();
  if (archive.length === 0) return container.textContent = '過去のセッションはありません。';
  archive.forEach((sess, idx) => {
    const wrapper = document.createElement('div');
    const btn = document.createElement('button');
    const firstUserMsg = sess.messages.find(m => m.role === 'user');
    const firstQuestion = firstUserMsg ? firstUserMsg.content.slice(0, 30).replace(/\n/g, ' ') + (firstUserMsg.content.length > 30 ? '…' : '') : '(最初の質問なし)';
    const originalTitle = sess.title;
let displayTitle;
const parts = originalTitle.match(/^(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})/);

if (parts) {
  const yyyy = parts[1], mm = parts[2], dd = parts[3];
  const hh = parts[4], min = parts[5], ss = parts[6];

  if (window.innerWidth <= 600) {
    // スマホ向け表示：yy/m/d h:mm
    const yy = yyyy.slice(2);
    const m = String(Number(mm));
    const d = String(Number(dd));
    const h = String(Number(hh));
    const paddedMin = min.padStart(2, '0');  // ← 分だけゼロ埋め
    displayTitle = `${yy}/${m}/${d} ${h}:${paddedMin}`;
  } else {
    // PC向け表示：yyyy/mm/dd hh:mm:ss
    displayTitle = `${yyyy}/${mm}/${dd} ${hh}:${min}:${ss}`;
  }
} else {
  displayTitle = originalTitle;
}
btn.textContent = `📁 ${displayTitle}｜${firstQuestion}`;
    btn.onclick = () => {  const content = sess.messages.map(m => `[${m.role}] ${m.content}`).join('\n\n'); document.getElementById('modal-content').textContent = content; document.getElementById('modal').style.display = 'block';};
    const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `session-${idx}`; checkbox.className = 'session-checkbox';checkbox.style.margin = '0';checkbox.style.transform = 'scale(1.2)';
    const copyBtn = document.createElement('button'); copyBtn.textContent = '📋'; copyBtn.style.width = '30px';
    copyBtn.onclick = () => { const text = sess.messages.map(m => `${m.role}: ${m.content}`).join('\n'); const tempArea = document.createElement('textarea');  tempArea.value = text; document.body.appendChild(tempArea); tempArea.select(); try {document.execCommand('copy'); alert('セッション内容をコピーしました'); } catch (err) { alert('コピーに失敗しました');  } document.body.removeChild(tempArea); }; wrapper.appendChild(btn); wrapper.appendChild(checkbox); wrapper.appendChild(copyBtn); container.appendChild(wrapper);});
}
function copyModalContent() {
  const text = document.getElementById('modal-content').textContent;
  const tempArea = document.createElement('textarea');
  tempArea.value = text;
  document.body.appendChild(tempArea);
  tempArea.select();try { document.execCommand('copy');alert('モーダルの内容をコピーしました。');} catch (err) { alert('コピーに失敗しました。');}
  document.body.removeChild(tempArea);
}

window.addEventListener('load', () => {  sessionMsgs.forEach(m => append(m.role, m.content));  saveAll();  renderPastSessions();  const questionInput = document.getElementById('question');  questionInput.addEventListener('input', () => {    questionInput.style.height = 'auto';    questionInput.style.height = questionInput.scrollHeight + 'px';  });});

document.getElementById('clear-history').addEventListener('click', () => {
  if (!confirm('履歴をリセットしますか？')) return;
  sessionMsgs = []; localStorage.removeItem('chat-history'); chatLog.innerHTML = ''; saveAll();
});

document.getElementById('clear-cost').addEventListener('click', () => {
  if (!confirm('トークン・コストをリセットしますか？')) return;
  totalIn = 0; totalOut = 0; totalCost = 0;
  localStorage.setItem('in-tokens', '0'); localStorage.setItem('out-tokens', '0'); localStorage.setItem('cost-jpy', '0'); saveAll();
});

document.getElementById('end-session').addEventListener('click', archiveSession);

document.getElementById('ask-button').addEventListener('click', async () => {
  const cont = document.getElementById('continue-session').checked;
  if (!cont) sessionMsgs = []; 
  if (isRequesting) return;          // ★ 連打ガード
  isRequesting = true;
  askBtn.disabled = true;            // ★ ボタンを物理的に無効化
  askBtn.textContent = '⏳ 送信中…';
  const apiKey = document.getElementById('api-key').value.trim();
  const q = document.getElementById('question').value.trim();
  if (!apiKey || !q) return alert('APIキーと質問を入力してください');
  append('user', q);
  const model = document.getElementById('model').value;
  const role = document.getElementById('role').value;
  const temp = parseFloat(document.getElementById('temperature').value);
  const maxT = parseInt(document.getElementById('max-tokens').value);
  let msgsToSend = cont ? [...sessionMsgs] : [];
  if (!msgsToSend.some(m => m.role === 'system')) msgsToSend.unshift({ role: 'system', content: role });
  msgsToSend.push({ role: 'user', content: q });
  try {
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
      body: JSON.stringify({ model, messages: msgsToSend, temperature: temp, max_tokens: maxT })
    });
    const data = await resp.json();
    if (!data.choices?.[0]?.message) return append('assistant', 'エラー: ' + (data.error?.message || '不明'));
    const reply = data.choices[0].message.content.trim();
    append('assistant', reply);
    const inT = data.usage?.prompt_tokens || 0;
    const outT = data.usage?.completion_tokens || 0;
    const costUsd = (inT / 1e6) * pricing[model].inp + (outT / 1e6) * pricing[model].out;
    const costJpy = costUsd * usdToJpy;
  sessionIn = inT;
  sessionOut = outT;
  sessionCost = costJpy;
    totalIn += inT; totalOut += outT; totalCost += costJpy;
    sessionMsgs.push({ role: 'user', content: q });
    sessionMsgs.push({ role: 'assistant', content: reply });
    document.getElementById('question').value = ''; saveAll();
  } catch (e) {
    append('assistant', 'エラー: ' + e.message);
  } finally {
    resetAskButton();                // ★ 成功でも失敗でもボタンを戻す
  }
});
function resetAskButton() {
  isRequesting = false;
  askBtn.disabled = false;
  askBtn.textContent = '❓GPTに聞く❓';
}

document.getElementById('export-selected').addEventListener('click', () => {
  const archive = JSON.parse(localStorage.getItem('archived-sessions') || '[]');
  if (archive.length === 0) return alert('過去のセッションはありません。');
  const checkedIndexes = Array.from(document.querySelectorAll('#past-sessions .session-checkbox')).map((cb, idx) => cb.checked ? idx : -1).filter(idx => idx !== -1);
  if (checkedIndexes.length === 0) return alert('エクスポートするセッションを選択してください。');
  let exportText = '';
  checkedIndexes.forEach(idx => {
    const sess = archive[idx];
    exportText += `=== セッション: ${sess.title} ===\n`;
    sess.messages.forEach(m => { exportText += `[${m.role}] ${m.content}\n`; });
    exportText += '\n\n';
  });
   const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // UTF-8 BOM
  const blob = new Blob([bom, exportText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `exported_sessions_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  alert('選択したセッションをテキストファイルとして保存しました。');
});

document.getElementById('delete-selected').addEventListener('click', () => {
  const archive = JSON.parse(localStorage.getItem('archived-sessions') || '[]');
  if (archive.length === 0) return alert('過去のセッションはありません。');

  const checkboxes = Array.from(document.querySelectorAll('#past-sessions .session-checkbox'));
  const checkedIndexes = checkboxes.map((cb, idx) => cb.checked ? idx : -1).filter(idx => idx !== -1);

  if (checkedIndexes.length === 0) return alert('削除するセッションを選択してください。');

  if (!confirm(`選択された ${checkedIndexes.length} 件のセッションを削除しますか？`)) return;

  // インデックスが小さい順に削除（後ろから処理すると崩れにくい）
  checkedIndexes.reverse().forEach(idx => {
    archive.splice(idx, 1);
  });

  localStorage.setItem('archived-sessions', JSON.stringify(archive));
  renderPastSessions();
  alert('選択したセッションを削除しました。');
});

document.getElementById('clear-all-sessions').addEventListener('click', () => {
  if (!confirm('⚠過去のセッションを全て削除しますか？ この操作は取り消せません。')) return;
  localStorage.removeItem('archived-sessions');
  renderPastSessions();
  alert('過去のセッションを全て削除しました。');
});
document.getElementById("modal-close").addEventListener("click", function () {
  document.getElementById("modal").style.display = "none";
});
  </script>

</body>
</html>