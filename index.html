<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPTalk</title>
  <!-- Styles -->
  <style>
    /* Color & Spacing Variables */
    :root {
      --bg-light: #f1f1f1;
      --panel-bg: #fff;
      --border-radius: 8px;
      --primary: #007bff;
      --primary-hover: #0056b3;
      --user-bubble: #f9e6e6;
      --assistant-bubble: #f0f4c3;
      --text-dark: #333;
      --text-muted: #555;
      --font-small: 0.8em;
    }

    /* Reset & Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      margin: 20px;
      background: var(--bg-light);
      font-family: sans-serif;
      color: var(--text-dark);
    }
    h2, h3 { margin-bottom: 10px; }

    /* Container */
    .container {
      max-width: 670px;
      margin: 0 auto;
      padding: 15px;
      background: var(--panel-bg);
      border-radius: var(--border-radius);
    }

    /* Form Rows */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
    }
    .form-row label {
      font-weight: bold;
      white-space: nowrap;
      font-size: var(--font-small);
    }

    /* Inputs & Select */
    input, select, textarea {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 1em;
    }
    textarea {
      width: 100%;
      resize: vertical;
      max-height: 300px;
      margin-bottom: 8px;
    }
    .small-input { max-width: 150px; font-size: var(--font-small); }

    /* Panels */
    .panel {
      padding: 15px;
      margin: 5px 0;
      background: var(--panel-bg);
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
    }
    .gpt-panel { background: #d6eaf8; }
    .session-panel { background: #fef6e4; }
    .reset-panel { background: #eee; }

    /* Chat Log & Bubbles */
    .chat-log {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding-bottom: 5px;
      max-height: 400px;
      overflow-y: auto;
    }
    .bubble {
      max-width: 85%;
      padding: 8px;
      border-radius: 15px;
      font-size: var(--font-small);
      line-height: 1.2;
      word-break: break-word;
    }
    .bubble.user {
      background: var(--user-bubble);
      align-self: flex-end;
    }
    .bubble.assistant {
      background: var(--assistant-bubble);
      align-self: flex-start;
    }

    /* Buttons */
    button {
      padding: 10px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1em;
    }
    .ask-button {
      width: 100%;
      background: var(--primary);
      color: #fff;
      font-weight: bold;
      font-size: 1.2em;
    }
    .ask-button:hover { background: var(--primary-hover); }
    .buttons-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 8px; }
    .buttons-row button { flex: 1; }

    /* Inline Controls */
    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 5px;
      background: var(--primary);
      color: #fff;
      padding: 6px 10px;
      border-radius: var(--border-radius);
      font-size: var(--font-small);
    }
    .checkbox-inline input { transform: scale(1.2); }
    .info-inline { font-size: var(--font-small); color: var(--text-muted); display: flex; gap: 10px; }

    /* Modal */
    #modal {
      position: fixed;
      inset: 10% 5%;
      background: var(--panel-bg);
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    #modal-header {
      display: flex;
      justify-content: flex-end;
      padding: 8px;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
    }
    #modal-content {
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      flex: 1;
    }

    /* Footer */
    .footer { text-align: center; font-size: 0.75em; color: #888; margin-top: 20px; }

    /* Responsive */
    @media (max-width: 600px) {
      body { margin: 5px; }
      .container { padding: 5px; }
      textarea { font-size: 0.9em; }
      .ask-button { font-size: 1em; }
      .checkbox-inline { font-size: 0.7em; padding: 4px; }
      .info-inline { font-size: 0.7em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header><h2>💬 GPTalk 💬</h2></header>

    <!-- Settings -->
    <form id="settings-form">
      <div class="form-row">
        <label for="api-key">API Key:</label>
        <input type="password" id="api-key" required>
      </div>
      <div class="form-row">
        <label for="model">モデル：</label>
        <select id="model" class="small-input">
          <option value="gpt-4o-mini">GPT‑4o‑mini</option>
          <option value="gpt-4.1-mini" selected>GPT‑4.1‑mini</option>
          <option value="gpt-4.1-nano">GPT‑4.1‑nano</option>
          <option value="o3-mini">o3‑mini</option>
        </select>
        <label for="temperature">温度：</label>
        <input type="number" id="temperature" class="small-input" value="0.2" min="0.0" max="1.0" step="0.1">
        <label for="max-tokens">最大トークン：</label>
        <input type="number" id="max-tokens" class="small-input" value="8000" min="1000" max="20000" step="1000">
      </div>
      <div class="form-row">
        <label for="role">役割：</label>
        <input type="text" id="role" value="あなたは、とても有能なアシスタントです。">
      </div>
    </form>

    <!-- Chat Panel -->
    <section class="panel gpt-panel">
      <div id="chat-log" class="chat-log"></div>
      <textarea id="question" placeholder="質問を入力..."></textarea>
      <div class="buttons-row">
        <label class="checkbox-inline"><input type="checkbox" id="markdown-toggle" checked> Markdown</label>
        <label class="checkbox-inline"><input type="checkbox" id="collapse-toggle" checked> 折り畳み</label>
        <label class="checkbox-inline"><input type="checkbox" id="continue-session"> 履歴引継</label>
      </div>
      <button id="ask-button" class="ask-button">❓ GPTに聞く</button>
      <div class="info-inline">
        Input: <span id="session-in-tokens">0</span> ｜ Output: <span id="session-out-tokens">0</span> ｜ <span id="session-cost-jpy">¥0</span>
      </div>
      <div class="buttons-row">
        <button id="clear-history">🗑️ 履歴リセット</button>
        <button id="end-session">📥 アーカイブ</button>
      </div>
    </section>

    <!-- Past Sessions -->
    <section class="panel session-panel">
      <h3>🔁 過去セッション</h3>
      <div id="past-sessions">過去のセッションはありません。</div>
      <div class="buttons-row">
        <button id="delete-selected">🗑️ 選択削除</button>
        <button id="export-selected">📄 txt保存</button>
      </div>
      <div class="info-inline">
        累計 Input: <span id="total-in-tokens">0</span> ｜ Output: <span id="total-out-tokens">0</span> ｜ <span id="cost-jpy">¥0</span>
      </div>
    </section>

    <!-- Reset Data -->
    <section class="panel reset-panel">
      <h3>🗑️ データ削除</h3>
      <div class="buttons-row">
        <button id="clear-cost">料金リセット</button>
        <button id="clear-all-sessions">全セッション削除</button>
      </div>
    </section>

    <!-- Modal -->
    <div id="modal">
      <div id="modal-header">
        <button id="modal-close">✖ 閉じる</button>
      </div>
      <pre id="modal-content"></pre>
    </div>

    <!-- Footer -->
    <footer class="footer">© 2025 GPTalk by AT. All rights reserved.</footer>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- App Script -->
  <script>
    /**
     * GPTalk Application Module
     */
    (function() {
      /* ---- Configuration ---- */
      const PRICING = {
        'gpt-4o-mini': { inp: 0.15, out: 0.60 },
        'gpt-4.1-mini': { inp: 0.40, out: 1.60 },
        'gpt-4.1-nano': { inp: 0.10, out: 0.40 },
        'o3-mini':      { inp: 2.00, out: 8.00 }
      };
      const USD_TO_JPY = 145;

      /* ---- State ---- */
      const state = {
        isRequesting: false,
        sessionMsgs: [],
        sessionIn: 0,
        sessionOut: 0,
        sessionCost: 0,
        totalIn: 0,
        totalOut: 0,
        totalCost: 0
      };

      /* ---- Utility ---- */
      const $ = id => document.getElementById(id);

      function formatTimestamp(ts) {
        if (ts) return ts;
        const d = new Date();
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}` +
               `/${String(d.getDate()).padStart(2,'0')} ` +
               `${String(d.getHours()).padStart(2,'0')}` +
               `:${String(d.getMinutes()).padStart(2,'0')}` +
               `:${String(d.getSeconds()).padStart(2,'0')}`;
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text)
          .then(() => alert('コピーしました。'))
          .catch(() => alert('コピー失敗。'));
      }

      /* ---- UI Handlers ---- */
      function appendMessage(role, content) {
        if (role === 'system') return;
        const log = $('chat-log');
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role}`;
        const md = $('markdown-toggle').checked;
        const clean = content.trim().replace(/\n{2,}/g, '\n');
        bubble.innerHTML = md ? marked.parse(clean) : clean;
        log.appendChild(bubble);
        log.scrollTop = log.scrollHeight;
        updateStats();
      }

      function renderPastSessions() {
        const container = $('past-sessions');
        const archives = JSON.parse(localStorage.getItem('archived-sessions')||'[]').reverse();
        container.innerHTML = archives.length ? '' : '過去のセッションはありません。';
        archives.forEach((sess, i) => {
          const btn = document.createElement('button');
          const first = sess.messages.find(m=>m.role==='user')?.content.slice(0,30) || '';
          btn.textContent = `📁 ${formatTimestamp(sess.title)} | ${first}…`;
          btn.onclick = () => showModal(sess.messages.map(m=>`[${m.role}] ${m.content}`).join('\n\n'));
          container.appendChild(btn);
        });
      }

      function showModal(text) {
        $('modal-content').textContent = text;
        $('modal').style.display = 'flex';
      }

      function updateStats() {
        const charsIn = state.sessionMsgs
          .filter(m=>m.role==='user')
          .reduce((sum,m)=>sum+m.content.length,0);
        const charsOut = state.sessionMsgs
          .filter(m=>m.role==='assistant')
          .reduce((sum,m)=>sum+m.content.length,0);
        const model = $('model').value;
        const tokensIn = Math.ceil(charsIn/4);
        const tokensOut = Math.ceil(charsOut/4);
        const costUsd = (tokensIn/1e6)*PRICING[model].inp + (tokensOut/1e6)*PRICING[model].out;
        state.sessionIn = tokensIn;
        state.sessionOut = tokensOut;
        state.sessionCost = costUsd * USD_TO_JPY;
        $('session-in-tokens').textContent = tokensIn;
        $('session-out-tokens').textContent = tokensOut;
        $('session-cost-jpy').textContent = `¥${state.sessionCost.toFixed(1)}`;
      }

      /* ---- Storage ---- */
      const storage = {
        save() {
          localStorage.setItem('chat-history', JSON.stringify(state.sessionMsgs));
          localStorage.setItem('in-tokens', state.totalIn);
          localStorage.setItem('out-tokens', state.totalOut);
          localStorage.setItem('cost-jpy', state.totalCost.toFixed(2));
        },
        load() {
          state.sessionMsgs = JSON.parse(localStorage.getItem('chat-history')||'[]');
          state.totalIn = +localStorage.getItem('in-tokens')||0;
          state.totalOut = +localStorage.getItem('out-tokens')||0;
          state.totalCost = +localStorage.getItem('cost-jpy')||0;
          state.sessionMsgs.forEach(m=>appendMessage(m.role,m.content));
        },
        clearChat() { if (!confirm('履歴リセット?')) return; state.sessionMsgs = []; localStorage.removeItem('chat-history'); $('chat-log').innerHTML=''; saveAll(); },
        clearCost() { if (!confirm('コストリセット?')) return; state.totalIn=0; state.totalOut=0; state.totalCost=0; storage.save(); initStats(); },
        archive() { /* omitted for brevity */ },
      };

      /* ---- API ---- */
      async function sendMessage() {
        if (state.isRequesting) return;
        const question = $('question').value.trim();
        const apiKey   = $('api-key').value.trim();
        const model    = $('model').value;
        const temp     = +$('temperature').value;
        const maxT     = +$('max-tokens').value;
        const keep     = $('continue-session').checked;
        if (!question || !apiKey) return alert('APIキーと質問を入力');

        state.isRequesting = true;
        $('ask-button').disabled = true;
        appendMessage('user', question);

        let messages = keep ? [...state.sessionMsgs] : [];
        if (!messages.some(m=>m.role==='system')) {
          messages.unshift({ role: 'system', content: $('role').value });
        }
        messages.push({ role: 'user', content: question });

        try {
          const res = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
            body: JSON.stringify({ model, messages, temperature: temp, max_tokens: maxT })
          });
          const data = await res.json();
          if (!data.choices?.[0]?.message) throw new Error(data.error?.message || 'Unknown');
          const reply = data.choices[0].message.content.trim();
          appendMessage('assistant', reply);

          const inT  = data.usage.prompt_tokens || 0;
          const outT = data.usage.completion_tokens || 0;
          const cost = ((inT/1e6)*PRICING[model].inp + (outT/1e6)*PRICING[model].out) * USD_TO_JPY;

          state.sessionMsgs.push({ role:'user', content: question }, { role:'assistant', content: reply });
          state.totalIn  += inT;
          state.totalOut += outT;
          state.totalCost += cost;
          storage.save();
          initStats();
          $('question').value = '';
        } catch(err) {
          appendMessage('assistant', 'エラー: '+err.message);
        } finally {
          state.isRequesting = false;
          $('ask-button').disabled = false;
        }
      }

      /* ---- Events & Init ---- */
      function bindEvents() {
        $('ask-button').addEventListener('click', sendMessage);
        $('clear-history').addEventListener('click', ()=>storage.clearChat());
        $('clear-cost').addEventListener('click', ()=>storage.clearCost());
        $('modal-close').addEventListener('click', ()=>$('modal').style.display='none');
        // ... other bindings
      }

      function initStats() {
        $('total-in-tokens').textContent  = state.totalIn;
        $('total-out-tokens').textContent = state.totalOut;
        $('cost-jpy').textContent         = `¥${state.totalCost.toFixed(1)}`;
      }

      function init() {
        storage.load();
        initStats();
        renderPastSessions();
        bindEvents();
      }

      // Start App
      init();
    })();
  </script>
</body>
</html>
